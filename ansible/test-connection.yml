---
- name: Test TrueNAS SCALE Connection and Permissions
  hosts: truenas
  gather_facts: true
  tasks:
    - name: Test basic connectivity
      ping:
      tags: connectivity

    - name: Check Python version
      command: python3 --version
      register: python_version
      changed_when: false
      tags: python

    - name: Test privilege escalation
      command: whoami
      become: true
      register: privilege_test
      changed_when: false
      tags: sudo

    - name: Check ZFS pool status
      command: zpool status {{ zfs_pool }}
      become: true
      register: zfs_status
      changed_when: false
      tags: zfs

    - name: Test ZFS dataset creation (dry-run)
      command: zfs list {{ zfs_pool }}
      become: true
      register: zfs_list
      changed_when: false
      tags: zfs

    - name: Check available disk space
      command: df -h /mnt/{{ zfs_pool }}
      become: true
      register: disk_space
      changed_when: false
      failed_when: false
      tags: storage

    - name: Display connection test results
      debug:
        msg:
          - "✅ Basic connectivity: SUCCESS"
          - "✅ Python version: {{ python_version.stdout }}"
          - "✅ Privilege escalation: {{ privilege_test.stdout }}"
          - "✅ ZFS pool '{{ zfs_pool }}' status: ONLINE"
          - "📊 Disk space: {{ disk_space.stdout_lines[1] if disk_space.stdout_lines else 'Unable to check' }}"
          - ""
          - "🎯 System ready for Ansible automation!"
      tags: results

    - name: Display system information
      debug:
        msg:
          - "🖥️  System: {{ ansible_system }} {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "🏗️  Architecture: {{ ansible_architecture }}"
          - "💾 Memory: {{ (ansible_memtotal_mb / 1024) | round(1) }} GB"
          - "🌐 IP Address: {{ ansible_default_ipv4.address }}"
          - "🔧 Hostname: {{ ansible_hostname }}"
      tags: info