---
- name: "Create or update dataset {{ dataset.name }} with properties"
  uri:
    url: "{{ truenas_api_url }}/pool/dataset"
    method: POST
    headers:
      Authorization: "Bearer {{ truenas_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ dataset.name }}"
      type: "FILESYSTEM"
      recordsize: "{{ dataset.recordsize }}"
      compression: "{{ dataset.compression | default(default_compression) }}"
      atime: "{{ default_atime }}"
    status_code: [200, 422]  # 200 = created, 422 = already exists
    validate_certs: "{{ truenas_validate_certs }}"
  register: dataset_result

- name: "Update properties for existing dataset {{ dataset.name }}"
  uri:
    url: "{{ truenas_api_url }}/pool/dataset/id/{{ dataset.name | replace('/', '%2F') }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ truenas_api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      recordsize: "{{ dataset.recordsize }}"
      compression: "{{ dataset.compression | default(default_compression) }}"
      atime: "{{ default_atime }}"
    status_code: [200]
    validate_certs: "{{ truenas_validate_certs }}"
  when: dataset_result.status == 422